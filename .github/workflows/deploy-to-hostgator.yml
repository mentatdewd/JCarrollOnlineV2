name: Deploy to HostGator

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
    
    - name: Restore NuGet packages
      run: nuget restore JCarrollOnlineV2.sln
      
    - name: Verify NuGet restore
      shell: pwsh
      run: |
        Write-Host "Verifying NuGet packages restored..." -ForegroundColor Cyan
        $packagesPath = "packages"
        if (Test-Path $packagesPath) {
          $packageCount = (Get-ChildItem -Path $packagesPath -Directory).Count
          Write-Host "✓ Found $packageCount NuGet packages" -ForegroundColor Green
        } else {
          Write-Warning "Packages folder not found"
        }
    
    - name: Clean output folders
      shell: pwsh
      run: |
        Write-Host "Cleaning output folders..." -ForegroundColor Cyan
        
        $foldersToClean = @(
          "JCarrollOnlineV2\bin",
          "JCarrollOnlineV2\obj",
          "publish-output"
        )
        
        foreach ($folder in $foldersToClean) {
          if (Test-Path $folder) {
            Write-Host "  Removing: $folder" -ForegroundColor Yellow
            Remove-Item -Path $folder -Recurse -Force -ErrorAction SilentlyContinue
          }
        }
        
        Write-Host "✓ Output folders cleaned" -ForegroundColor Green
    
    - name: Build solution
      run: msbuild JCarrollOnlineV2.sln /p:Configuration=Release /p:Platform="Any CPU" /t:Build /v:minimal
    
    - name: Create publish directory
      shell: pwsh
      run: |
        $publishDir = "publish-output"
        if (Test-Path $publishDir) {
          Remove-Item -Path $publishDir -Recurse -Force
        }
        New-Item -ItemType Directory -Path $publishDir -Force | Out-Null
        Write-Host "✓ Created publish directory: $publishDir" -ForegroundColor Green
    
    - name: Copy files for deployment
      shell: pwsh
      run: |
        Write-Host "Copying files for deployment..." -ForegroundColor Cyan
        
        $sourceDir = "JCarrollOnlineV2"
        $destDir = "publish-output"
        
        # Copy content files (excluding build artifacts and project files)
        Write-Host "Copying content files from $sourceDir to $destDir..." -ForegroundColor Cyan
        robocopy $sourceDir $destDir /E /XD obj .vs node_modules bin /XF *.csproj *.user *.sln *.pubxml /NFL /NDL /NJH /NJS /nc /ns /np
        
        # Robocopy returns exit codes 0-7 for success (1 = files copied successfully)
        if ($LASTEXITCODE -lt 8) { $global:LASTEXITCODE = 0 }
        
        # Copy the compiled bin folder with all assemblies
        Write-Host "Copying compiled binaries..." -ForegroundColor Cyan
        $binSource = Join-Path $sourceDir "bin"
        $binDest = Join-Path $destDir "bin"
        
        if (Test-Path $binSource) {
          robocopy $binSource $binDest /E /NFL /NDL /NJH /NJS /nc /ns /np
          if ($LASTEXITCODE -lt 8) { $global:LASTEXITCODE = 0 }
          
          # Verify critical DLLs
          $criticalDlls = @("JCarrollOnlineV2.dll", "EntityFramework.dll")
          foreach ($dll in $criticalDlls) {
            $dllPath = Join-Path $binDest $dll
            if (Test-Path $dllPath) {
              Write-Host "  ✓ Found: $dll" -ForegroundColor Green
            } else {
              Write-Warning "  ⚠ Missing: $dll"
            }
          }
        } else {
          Write-Error "Bin folder not found at: $binSource"
          exit 1
        }
        
        Write-Host "✓ Files copied successfully" -ForegroundColor Green
    
    - name: Verify published files
      id: find-publish
      shell: pwsh
      run: |
        $publishPath = "publish-output"
        
        Write-Host "Checking for published files..." -ForegroundColor Cyan
        
        if (-not (Test-Path "$publishPath\Web.config")) {
          Write-Error "Web.config not found in publish output"
          exit 1
        }
        
        if (-not (Test-Path "$publishPath\Global.asax")) {
          Write-Error "Global.asax not found in publish output"
          exit 1
        }
        
        if (-not (Test-Path "$publishPath\bin\JCarrollOnlineV2.dll")) {
          Write-Error "JCarrollOnlineV2.dll not found in bin folder"
          Write-Host "Contents of bin folder:" -ForegroundColor Yellow
          if (Test-Path "$publishPath\bin") {
            Get-ChildItem -Path "$publishPath\bin" | Select-Object Name, Length
          } else {
            Write-Error "Bin folder does not exist!"
          }
          exit 1
        }
        
        # Output the path for next steps
        $fullPath = (Resolve-Path $publishPath).Path
        echo "PUBLISH_PATH=$fullPath" >> $env:GITHUB_OUTPUT
        echo "PUBLISH_PATH_RELATIVE=$publishPath" >> $env:GITHUB_OUTPUT
        
        Write-Host "✓ All critical files found" -ForegroundColor Green
    
    - name: Replace secrets in Web.config
      shell: pwsh
      run: |
        $webConfigPath = Join-Path "${{ steps.find-publish.outputs.PUBLISH_PATH }}" "Web.config"
        
        Write-Host "Processing: $webConfigPath" -ForegroundColor Cyan
        
        if (-not (Test-Path $webConfigPath)) {
          Write-Error "Web.config not found at: $webConfigPath"
          exit 1
        }
        
        # Load as XML first for proper manipulation
        [xml]$xml = Get-Content $webConfigPath
        
        Write-Host "`n========== BEFORE REPLACEMENTS ==========" -ForegroundColor Magenta
        
        # Remove configBuilders attribute
        $connStringsNode = $xml.configuration.connectionStrings
        if ($connStringsNode) {
          if ($connStringsNode.HasAttribute("configBuilders")) {
            $connStringsNode.RemoveAttribute("configBuilders")
            Write-Host "✓ Removed configBuilders attribute" -ForegroundColor Green
          }
          
          # Replace connection strings using XML manipulation
          foreach ($add in $connStringsNode.add) {
            if ($add.connectionString -eq "__DEV_CONNECTION_STRING__") {
              $add.connectionString = '${{ secrets.__DEV_CONNECTION_STRING__ }}'
              Write-Host "✓ Replaced DEV connection string" -ForegroundColor Green
            }
            if ($add.connectionString -eq "__PROD_CONNECTION_STRING__") {
              $add.connectionString = '${{ secrets.__PROD_CONNECTION_STRING__ }}'
              Write-Host "✓ Replaced PROD connection string" -ForegroundColor Green
            }
          }
        } else {
          Write-Error "❌ No connectionStrings section found!"
          exit 1
        }
        
        # Handle machine keys
        $systemWeb = $xml.configuration.'system.web'
        if ($systemWeb) {
          $machineKey = $systemWeb.machineKey
          if ($machineKey) {
            if ($machineKey.validationKey -eq "__MACHINEKEY_VALIDATION__") {
              $machineKey.validationKey = '${{ secrets.__MACHINEKEY_VALIDATION__ }}'
              Write-Host "✓ Replaced MACHINEKEY_VALIDATION" -ForegroundColor Green
            }
            if ($machineKey.decryptionKey -eq "__MACHINEKEY_DECRYPTION__") {
              $machineKey.decryptionKey = '${{ secrets.__MACHINEKEY_DECRYPTION__ }}'
              Write-Host "✓ Replaced MACHINEKEY_DECRYPTION" -ForegroundColor Green
            }
          }
          
          # Set debug to false
          $compilation = $systemWeb.compilation
          if ($compilation -and $compilation.debug -eq "true") {
            $compilation.debug = "false"
            Write-Host "✓ Set debug=false" -ForegroundColor Green
          }
        }
        
        # Handle SMTP password
        $systemNet = $xml.configuration.'system.net'
        if ($systemNet) {
          $smtp = $systemNet.mailSettings.smtp
          if ($smtp) {
            $network = $smtp.network
            if ($network) {
              if ([string]::IsNullOrEmpty($network.password) -or $network.password -eq "__SMTP_PASSWORD__") {
                $network.password = '${{ secrets.__SMTP_PASSWORD__ }}'
                Write-Host "✓ Replaced SMTP password" -ForegroundColor Green
              }
            }
          }
        }
        
        # Save the modified XML
        $xml.Save($webConfigPath)
        
        Write-Host "`n========== VERIFICATION ==========" -ForegroundColor Magenta
        
        # Verify connection strings
        [xml]$verifyXml = Get-Content $webConfigPath
        $connStrings = $verifyXml.configuration.connectionStrings
        
        if ($connStrings) {
          foreach ($add in $connStrings.add) {
            Write-Host "`nConnection: $($add.name)" -ForegroundColor Cyan
            $connStr = $add.connectionString
            
            if ($connStr -match '__.*?__') {
              Write-Error "  ❌ Still contains placeholder: $connStr"
              exit 1
            } elseif ([string]::IsNullOrWhiteSpace($connStr)) {
              Write-Error "  ❌ Connection string is empty!"
              exit 1
            } else {
              Write-Host "  ✓ Valid (length: $($connStr.Length) chars)" -ForegroundColor Green
              Write-Host "  Preview: $($connStr.Substring(0, [Math]::Min(60, $connStr.Length)))..." -ForegroundColor Gray
            }
          }
        } else {
          Write-Error "❌ No connectionStrings section found after save!"
          exit 1
        }
        
        Write-Host "`n✓ Web.config successfully updated" -ForegroundColor Green
    
    - name: List published files
      shell: pwsh
      run: |
        Write-Host "`nPublished files structure:" -ForegroundColor Cyan
        $publishPath = "${{ steps.find-publish.outputs.PUBLISH_PATH }}"
        
        if (Test-Path $publishPath) {
          $files = Get-ChildItem -Path $publishPath -Recurse | Where-Object { -not $_.PSIsContainer }
          Write-Host "Total files: $($files.Count)"
          
          # Show key directories
          Write-Host "`nTop-level items:" -ForegroundColor Yellow
          Get-ChildItem -Path $publishPath | 
            Select-Object Name, @{Name='Type';Expression={if($_.PSIsContainer){'DIR'}else{'FILE'}}}, Length |
            Format-Table -AutoSize
          
          # Show bin folder contents
          Write-Host "`nBin folder DLLs:" -ForegroundColor Yellow
          $binPath = Join-Path $publishPath "bin"
          if (Test-Path $binPath) {
            Get-ChildItem -Path $binPath -Filter "*.dll" | 
              Select-Object Name, Length |
              Format-Table -AutoSize
          }
        } else {
          Write-Warning "Publish path not found: $publishPath"
        }
    
    - name: Deploy to HostGator via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: mentatdewd
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ${{ steps.find-publish.outputs.PUBLISH_PATH_RELATIVE }}/
        server-dir: /httpdocs/jcarrollonline/
        dangerous-clean-slate: false
        log-level: verbose
        exclude: |
          **/.git*
          **/.git*/**
          **/secrets.xml
          **/*.pdb
          **/packages.config
          **/upgrade.log
          **/.vs/**
          **/Web.Release.config
          **/Web.Debug.config