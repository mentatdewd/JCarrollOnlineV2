name: Deploy to HostGator

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
    
    - name: Restore NuGet packages
      run: nuget restore JCarrollOnlineV2.sln
      
    - name: Verify NuGet restore
      shell: pwsh
      run: |
        Write-Host "Verifying NuGet packages restored..." -ForegroundColor Cyan
        $packagesPath = "packages"
        if (Test-Path $packagesPath) {
          $packageCount = (Get-ChildItem -Path $packagesPath -Directory).Count
          Write-Host "✓ Found $packageCount NuGet packages" -ForegroundColor Green
        } else {
          Write-Warning "Packages folder not found"
        }
    
    - name: Build and Publish
      shell: pwsh
      run: |
        # Build with explicit publish output - NO publish profile required
        msbuild JCarrollOnlineV2/JCarrollOnlineV2.csproj `
          /p:Configuration=Release `
          /p:Platform=AnyCPU `
          /p:DeployOnBuild=true `
          /p:WebPublishMethod=FileSystem `
          /p:publishUrl="bin\Release\Publish" `
          /p:DeleteExistingFiles=true `
          /p:TransformWebConfigEnabled=true `
          /p:AutoParameterizationWebConfigConnectionStrings=false `
          /t:Clean `
          /t:Build `
          /t:WebPublish `
          /v:normal
        
        Write-Host "Build completed" -ForegroundColor Green
    
    - name: Find published files
      id: find-publish
      shell: pwsh
      run: |
        # Search for published Web.config
        $possiblePaths = @(
          "JCarrollOnlineV2\bin\Release\Publish",
          "JCarrollOnlineV2\obj\Release\Package\PackageTmp",
          "publish-output",
          "JCarrollOnlineV2\publish-output",
          "JCarrollOnlineV2\bin\app.publish"
        )
        
        $publishPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path "$path\Web.config") {
            $publishPath = $path
            Write-Host "✓ Found published files at: $publishPath" -ForegroundColor Green
            break
          }
        }
        
        if (-not $publishPath) {
          Write-Error "Could not find published Web.config in any expected location"
          Write-Host "Searching entire workspace..." -ForegroundColor Yellow
          Get-ChildItem -Path "." -Filter "Web.config" -Recurse | 
            Where-Object { $_.FullName -notlike "*\obj\Debug\*" -and $_.FullName -notlike "*\.vs\*" } |
            ForEach-Object { Write-Host $_.FullName }
          exit 1
        }
        
        # Output the path for next steps
        $fullPath = (Resolve-Path $publishPath).Path
        echo "PUBLISH_PATH=$fullPath" >> $env:GITHUB_OUTPUT
        echo "PUBLISH_PATH_RELATIVE=$publishPath" >> $env:GITHUB_OUTPUT
        
        Write-Host "Published path set to: $publishPath" -ForegroundColor Cyan
    
    - name: Replace secrets in Web.config
      shell: pwsh
      run: |
        $webConfigPath = Join-Path "${{ steps.find-publish.outputs.PUBLISH_PATH }}" "Web.config"
        
        Write-Host "Processing: $webConfigPath" -ForegroundColor Cyan
        
        if (-not (Test-Path $webConfigPath)) {
          Write-Error "Web.config not found at: $webConfigPath"
          exit 1
        }
        
        $content = Get-Content $webConfigPath -Raw
        
        # Track changes
        $changes = 0
        
        # Replace machine keys
        if ($content -match '__MACHINEKEY_VALIDATION__') {
          $content = $content -replace '__MACHINEKEY_VALIDATION__', '${{ secrets.MACHINEKEY_VALIDATION }}'
          Write-Host "✓ Replaced MACHINEKEY_VALIDATION" -ForegroundColor Green
          $changes++
        }
        
        if ($content -match '__MACHINEKEY_DECRYPTION__') {
          $content = $content -replace '__MACHINEKEY_DECRYPTION__', '${{ secrets.MACHINEKEY_DECRYPTION }}'
          Write-Host "✓ Replaced MACHINEKEY_DECRYPTION" -ForegroundColor Green
          $changes++
        }
        
        # Replace connection strings
        if ($content -match '__DEV_CONNECTION_STRING__') {
          $content = $content -replace '__DEV_CONNECTION_STRING__', '${{ secrets.DEV_CONNECTION_STRING }}'
          Write-Host "✓ Replaced DEV_CONNECTION_STRING" -ForegroundColor Green
          $changes++
        }
        
        if ($content -match '__PROD_CONNECTION_STRING__') {
          $content = $content -replace '__PROD_CONNECTION_STRING__', '${{ secrets.PROD_CONNECTION_STRING }}'
          Write-Host "✓ Replaced PROD_CONNECTION_STRING" -ForegroundColor Green
          $changes++
        }
        
        # Replace SMTP password (handle both old hardcoded and placeholder)
        if ($content -match 'password="jV41wt\^5"') {
          $content = $content -replace 'password="jV41wt\^5"', 'password="${{ secrets.SMTP_PASSWORD }}"'
          Write-Host "✓ Replaced hardcoded SMTP password" -ForegroundColor Green
          $changes++
        }
        
        if ($content -match '__SMTP_PASSWORD__') {
          $content = $content -replace '__SMTP_PASSWORD__', '${{ secrets.SMTP_PASSWORD }}'
          Write-Host "✓ Replaced SMTP_PASSWORD placeholder" -ForegroundColor Green
          $changes++
        }
        
        Set-Content $webConfigPath $content -NoNewline
        Write-Host "`n✓ Total replacements made: $changes" -ForegroundColor Cyan
    
    - name: List published files
      shell: pwsh
      run: |
        Write-Host "`nPublished files structure:" -ForegroundColor Cyan
        $publishPath = "${{ steps.find-publish.outputs.PUBLISH_PATH }}"
        
        if (Test-Path $publishPath) {
          $files = Get-ChildItem -Path $publishPath -Recurse
          Write-Host "Total files: $($files.Count)"
          $files | Select-Object FullName, Length | Format-Table -AutoSize
        } else {
          Write-Warning "Publish path not found: $publishPath"
        }
    
    - name: Deploy to HostGator via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: mentatdewd
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ${{ steps.find-publish.outputs.PUBLISH_PATH_RELATIVE }}/
        server-dir: /public_html/
        dangerous-clean-slate: false
        log-level: verbose
        exclude: |
          **/.git*
          **/.git*/**
          **/secrets.xml
          **/*.pdb
          **/packages.config
          **/upgrade.log
          **/.vs/**
