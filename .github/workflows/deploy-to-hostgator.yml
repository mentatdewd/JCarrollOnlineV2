name: Deploy to HostGator

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
    
    - name: Restore NuGet packages
      run: nuget restore JCarrollOnlineV2.sln
    
    - name: Replace secrets in Web.config
      shell: pwsh
      run: |
        $webConfigPath = "JCarrollOnlineV2\Web.config"
        $content = Get-Content $webConfigPath -Raw
        
        # Replace machine keys
        $content = $content -replace '__MACHINEKEY_VALIDATION__', '${{ secrets.MACHINEKEY_VALIDATION }}'
        $content = $content -replace '__MACHINEKEY_DECRYPTION__', '${{ secrets.MACHINEKEY_DECRYPTION }}'
        
        # Replace connection strings
        $content = $content -replace '__DEV_CONNECTION_STRING__', '${{ secrets.DEV_CONNECTION_STRING }}'
        $content = $content -replace '__PROD_CONNECTION_STRING__', '${{ secrets.PROD_CONNECTION_STRING }}'
        
        # Replace SMTP password
        $content = $content -replace 'password="jV41wt\^5"', 'password="${{ secrets.SMTP_PASSWORD }}"'
        
        Set-Content $webConfigPath $content -NoNewline
        Write-Host "✓ Web.config secrets replaced successfully" -ForegroundColor Green
    
    - name: Build solution
      run: msbuild JCarrollOnlineV2.sln /p:Configuration=Release /p:DeployOnBuild=true
    
    - name: Deploy to HostGator via FTP
      uses: SamKirkland/FTP-Deploy-Action@4.3.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./JCarrollOnlineV2/bin/Release/Publish/
        server-dir: /public_html/
        exclude: |
          **/.git*
          **/.git*/**
          secrets.xml