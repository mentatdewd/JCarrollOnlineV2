name: Deploy to HostGator

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2.0.0
    
    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.config') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore NuGet packages
      shell: pwsh
      run: |
        Write-Host "Restoring NuGet packages..." -ForegroundColor Cyan
        nuget restore JCarrollOnlineV2.sln
        
        # Quick verification
        if (Test-Path "packages") {
          $count = (Get-ChildItem -Path "packages" -Directory).Count
          Write-Host "✓ Restored $count packages" -ForegroundColor Green
        }
    
    - name: Clean and prepare output
      shell: pwsh
      run: |
        Write-Host "Cleaning output folders..." -ForegroundColor Cyan
        
        @("JCarrollOnlineV2\bin", "JCarrollOnlineV2\obj", "publish-output") | ForEach-Object {
          if (Test-Path $_) {
            Remove-Item -Path $_ -Recurse -Force -ErrorAction SilentlyContinue
          }
        }
        
        New-Item -ItemType Directory -Path "publish-output" -Force | Out-Null
        Write-Host "✓ Cleaned and created publish directory" -ForegroundColor Green
    
    - name: Build solution
      run: msbuild JCarrollOnlineV2.sln /p:Configuration=Release /p:Platform="Any CPU" /p:DebugType=None /t:Build /v:minimal /m
    
    - name: Copy files for deployment
      shell: pwsh
      run: |
        Write-Host "Copying files for deployment..." -ForegroundColor Cyan
        
        $sourceDir = "JCarrollOnlineV2"
        $destDir = "publish-output"
        
        # Copy all content files excluding build artifacts
        robocopy $sourceDir $destDir /E /XD obj .vs node_modules /XF *.csproj *.user *.sln *.pubxml /NFL /NDL /NJH /NJS /nc /ns /np
        if ($LASTEXITCODE -lt 8) { $global:LASTEXITCODE = 0 }
        
        # Copy compiled binaries
        $binSource = Join-Path $sourceDir "bin"
        $binDest = Join-Path $destDir "bin"
        
        if (Test-Path $binSource) {
          robocopy $binSource $binDest /E /NFL /NDL /NJH /NJS /nc /ns /np
          if ($LASTEXITCODE -lt 8) { $global:LASTEXITCODE = 0 }
          Write-Host "✓ Files copied successfully" -ForegroundColor Green
        } else {
          Write-Error "Bin folder not found"
          exit 1
        }
    
    - name: Verify and prepare deployment
      id: find-publish
      shell: pwsh
      run: |
        $publishPath = "publish-output"
        Write-Host "Verifying deployment files..." -ForegroundColor Cyan
        
        # Check critical files
        $criticalFiles = @(
          "$publishPath\Web.config",
          "$publishPath\Global.asax",
          "$publishPath\bin\JCarrollOnlineV2.dll",
          "$publishPath\bin\EntityFramework.dll"
        )
        
        foreach ($file in $criticalFiles) {
          if (-not (Test-Path $file)) {
            Write-Error "Missing critical file: $file"
            exit 1
          }
        }
        
        # Output paths
        $fullPath = (Resolve-Path $publishPath).Path
        echo "PUBLISH_PATH=$fullPath" >> $env:GITHUB_OUTPUT
        echo "PUBLISH_PATH_RELATIVE=$publishPath" >> $env:GITHUB_OUTPUT
        
        Write-Host "✓ All critical files verified" -ForegroundColor Green
    
    - name: Replace secrets in Web.config
      shell: pwsh
      env:
        DEV_CONN: ${{ secrets.__DEV_CONNECTION_STRING__ }}
        PROD_CONN: ${{ secrets.__PROD_CONNECTION_STRING__ }}
        MACH_VAL: ${{ secrets.__MACHINEKEY_VALIDATION__ }}
        MACH_DEC: ${{ secrets.__MACHINEKEY_DECRYPTION__ }}
        SMTP_PWD: ${{ secrets.__SMTP_PASSWORD__ }}
      run: |
        $webConfigPath = Join-Path "${{ steps.find-publish.outputs.PUBLISH_PATH }}" "Web.config"
        
        if (-not (Test-Path $webConfigPath)) {
          Write-Error "Web.config not found"
          exit 1
        }
        
        [xml]$xml = Get-Content $webConfigPath
        
        # Remove configBuilders
        $connStrings = $xml.configuration.connectionStrings
        if ($connStrings.HasAttribute("configBuilders")) {
          $connStrings.RemoveAttribute("configBuilders")
        }
        
        # Replace connection strings
        foreach ($add in $connStrings.add) {
          if ($add.connectionString -eq "__DEV_CONNECTION_STRING__") {
            $add.connectionString = $env:DEV_CONN
            Write-Host "✓ Replaced DEV connection string" -ForegroundColor Green
          }
          if ($add.connectionString -eq "__PROD_CONNECTION_STRING__") {
            $add.connectionString = $env:PROD_CONN
            Write-Host "✓ Replaced PROD connection string" -ForegroundColor Green
          }
        }
        
        # Handle machine keys
        $systemWeb = $xml.configuration.'system.web'
        if ($systemWeb) {
          $machineKey = $systemWeb.machineKey
          if ($machineKey) {
            if ($machineKey.validationKey -eq "__MACHINEKEY_VALIDATION__") {
              $machineKey.validationKey = $env:MACH_VAL
              Write-Host "✓ Replaced MACHINEKEY_VALIDATION" -ForegroundColor Green
            }
            if ($machineKey.decryptionKey -eq "__MACHINEKEY_DECRYPTION__") {
              $machineKey.decryptionKey = $env:MACH_DEC
              Write-Host "✓ Replaced MACHINEKEY_DECRYPTION" -ForegroundColor Green
            }
          }
          
          # Set debug=false
          $compilation = $systemWeb.compilation
          if ($compilation -and $compilation.debug -eq "true") {
            $compilation.debug = "false"
            Write-Host "✓ Set debug=false" -ForegroundColor Green
          }
        }
        
        # Handle SMTP password
        $systemNet = $xml.configuration.'system.net'
        if ($systemNet.mailSettings.smtp.network) {
          $network = $systemNet.mailSettings.smtp.network
          if ([string]::IsNullOrEmpty($network.password) -or $network.password -eq "__SMTP_PASSWORD__") {
            $network.password = $env:SMTP_PWD
            Write-Host "✓ Replaced SMTP password" -ForegroundColor Green
          }
        }
        
        # Save with UTF-8 encoding
        $settings = New-Object System.Xml.XmlWriterSettings
        $settings.Indent = $true
        $settings.IndentChars = "  "
        $settings.Encoding = [System.Text.Encoding]::UTF8
        
        $writer = [System.Xml.XmlWriter]::Create($webConfigPath, $settings)
        $xml.Save($writer)
        $writer.Close()
        
        # Verify no placeholders remain
        [xml]$verify = Get-Content $webConfigPath
        foreach ($add in $verify.configuration.connectionStrings.add) {
          if ($add.connectionString -match '__.*?__') {
            Write-Error "Placeholder still exists in $($add.name)"
            exit 1
          }
        }
        
        Write-Host "✓ Web.config successfully updated and verified" -ForegroundColor Green
    
    - name: Deploy to HostGator via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: mentatdewd
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ${{ steps.find-publish.outputs.PUBLISH_PATH_RELATIVE }}/
        server-dir: /httpdocs/jcarrollonline/
        dangerous-clean-slate: false
        log-level: standard
        exclude: |
          **/.git*
          **/.git*/**
          **/secrets.xml
          **/*.pdb
          **/packages.config
          **/upgrade.log
          **/.vs/**
          **/Web.Release.config
          **/Web.Debug.config