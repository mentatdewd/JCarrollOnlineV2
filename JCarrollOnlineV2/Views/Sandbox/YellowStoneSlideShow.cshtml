@using JCarrollOnlineV2.ViewModels.Sandbox
@model YellowstoneViewModel

@{
    Model.PageTitle = "Yellowstone Slide Show";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .slideshow-container {
        position: relative;
        background-color: #000;
        min-height: 600px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .slideshow-wrapper {
        position: relative;
        width: 100%;
        height: 70vh;
        min-height: 500px;
    }

    .slide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 1.5s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .slide.active {
        opacity: 1;
        z-index: 2;
    }

    .slide img {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
    }

    .slide-caption {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        max-width: 80%;
        text-align: center;
    }

    .controls-panel {
        text-align: center;
        margin: 20px 0;
    }

    .controls-panel .btn {
        margin: 0 5px;
    }

    .progress-bar-container {
        height: 4px;
        background-color: #f0f0f0;
        margin-bottom: 10px;
        position: relative;
    }

    .progress-bar {
        height: 100%;
        background-color: #007bff;
        width: 0%;
        transition: width 0.3s ease;
    }

    .nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(255, 255, 255, 0.3);
        color: white;
        border: none;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        z-index: 10;
        transition: background-color 0.3s;
    }

    .nav-arrow:hover {
        background-color: rgba(255, 255, 255, 0.5);
    }

    .nav-arrow.prev {
        left: 20px;
    }

    .nav-arrow.next {
        right: 20px;
    }

    .slide-counter {
        position: absolute;
        top: 10px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        z-index: 10;
    }

    .thumbnails {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 10px;
        flex-wrap: wrap;
    }

    .thumbnail {
        width: 60px;
        height: 40px;
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.3s;
        border: 2px solid transparent;
    }

    .thumbnail:hover,
    .thumbnail.active {
        opacity: 1;
        border-color: #007bff;
    }

    .thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        z-index: 5;
    }

    @@keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
</style>

<div class="container-fluid">
    <h2>Yellowstone Slide Show</h2>

    <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="controls-panel">
        <button type="button" class="btn btn-primary" id="playPauseBtn">
            <span class="glyphicon glyphicon-pause"></span> Pause
        </button>
        <button type="button" class="btn btn-secondary" id="fullscreenBtn">
            <span class="glyphicon glyphicon-fullscreen"></span> Fullscreen
        </button>
        <span class="badge badge-info ml-2">
            <span id="currentSlide">1</span> / <span id="totalSlides">@Model.ImageFiles.Count()</span>
        </span>
    </div>

    <div class="slideshow-container" id="slideshowContainer">
        <div class="slideshow-wrapper">
            <div class="slide-counter">
                <span id="slideCounter">1 / @Model.ImageFiles.Count()</span>
            </div>

            <div id="loadingSpinner" class="loading-spinner" style="display: none;"></div>

            @{
                var slideIndex = 0;
                foreach (var image in Model.ImageFiles)
                {
                    <div class="slide @(slideIndex == 0 ? "active" : "")" data-slide-index="@slideIndex">
                        <img src="@image.Path" alt="@image.AltString" loading="@(slideIndex == 0 ? "eager" : "lazy")" />
                        @if (slideIndex == 0)
                        {
                            <div class="slide-caption">
                                <h5>Arrival in Yellowstone City</h5>
                                <p>The day of our arrival Ally went shopping</p>
                            </div>
                        }
                    </div>
                    slideIndex++;
                }
            }

            <button class="nav-arrow prev" id="prevBtn">‹</button>
            <button class="nav-arrow next" id="nextBtn">›</button>
        </div>
    </div>

    <div class="thumbnails" id="thumbnails">
        @{
            var thumbIndex = 0;
            foreach (var image in Model.ImageFiles)
            {
                <div class="thumbnail @(thumbIndex == 0 ? "active" : "")" data-thumb-index="@thumbIndex">
                    <img src="@image.Path" alt="@image.AltString" loading="lazy" />
                </div>
                thumbIndex++;
            }
        }
    </div>

    <div class="text-center mt-3">
        <p class="text-muted">
            <small>
                <span class="glyphicon glyphicon-info-sign"></span>
                Use arrow keys (← →) to navigate | Press Space to play/pause | Press F for fullscreen
            </small>
        </p>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            var currentSlide = 0;
            var totalSlides = @Model.ImageFiles.Count();
            var isPlaying = true;
            var interval = 4000;
            var slideTimer;

            // Preload all images
            function preloadImages() {
                $('.slide img').each(function() {
                    if (!this.complete) {
                        $('#loadingSpinner').show();
                    }
                });

                // Hide spinner when all images loaded
                var images = $('.slide img').toArray();
                var loadedCount = 0;
                images.forEach(function(img) {
                    if (img.complete) {
                        loadedCount++;
                    } else {
                        $(img).on('load', function() {
                            loadedCount++;
                            if (loadedCount === images.length) {
                                $('#loadingSpinner').hide();
                            }
                        });
                    }
                });
                if (loadedCount === images.length) {
                    $('#loadingSpinner').hide();
                }
            }

            function showSlide(index) {
                // Wrap around
                if (index >= totalSlides) index = 0;
                if (index < 0) index = totalSlides - 1;

                currentSlide = index;

                // Update slides
                $('.slide').removeClass('active');
                $('.slide[data-slide-index="' + index + '"]').addClass('active');

                // Update thumbnails
                $('.thumbnail').removeClass('active');
                $('.thumbnail[data-thumb-index="' + index + '"]').addClass('active');

                // Update counters
                $('#currentSlide').text(index + 1);
                $('#slideCounter').text((index + 1) + ' / ' + totalSlides);

                // Update progress bar
                var progress = ((index + 1) / totalSlides) * 100;
                $('#progressBar').css('width', progress + '%');
            }

            function nextSlide() {
                showSlide(currentSlide + 1);
            }

            function prevSlide() {
                showSlide(currentSlide - 1);
            }

            function startSlideshow() {
                stopSlideshow();
                slideTimer = setInterval(nextSlide, interval);
                isPlaying = true;
                $('#playPauseBtn').html('<span class="glyphicon glyphicon-pause"></span> Pause');
            }

            function stopSlideshow() {
                clearInterval(slideTimer);
                isPlaying = false;
                $('#playPauseBtn').html('<span class="glyphicon glyphicon-play"></span> Play');
            }

            // Navigation buttons
            $('#prevBtn').click(function() {
                prevSlide();
                if (isPlaying) startSlideshow();
            });

            $('#nextBtn').click(function() {
                nextSlide();
                if (isPlaying) startSlideshow();
            });

            // Play/Pause button
            $('#playPauseBtn').click(function() {
                if (isPlaying) {
                    stopSlideshow();
                } else {
                    startSlideshow();
                }
            });

            // Thumbnail clicks
            $('.thumbnail').click(function() {
                var index = parseInt($(this).data('thumb-index'));
                showSlide(index);
                if (isPlaying) startSlideshow();
            });

            // Fullscreen
            $('#fullscreenBtn').click(function() {
                var elem = $('#slideshowContainer')[0];
                if (!document.fullscreenElement) {
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.webkitRequestFullscreen) {
                        elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) {
                        elem.msRequestFullscreen();
                    }
                    $(this).html('<span class="glyphicon glyphicon-resize-small"></span> Exit Fullscreen');
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                    $(this).html('<span class="glyphicon glyphicon-fullscreen"></span> Fullscreen');
                }
            });

            // Handle fullscreen change
            document.addEventListener('fullscreenchange', function() {
                if (!document.fullscreenElement) {
                    $('#fullscreenBtn').html('<span class="glyphicon glyphicon-fullscreen"></span> Fullscreen');
                }
            });

            // Keyboard controls
            $(document).keydown(function(e) {
                switch(e.keyCode) {
                    case 37: // Left arrow
                        prevSlide();
                        if (isPlaying) startSlideshow();
                        break;
                    case 39: // Right arrow
                        nextSlide();
                        if (isPlaying) startSlideshow();
                        break;
                    case 32: // Space
                        e.preventDefault();
                        $('#playPauseBtn').click();
                        break;
                    case 70: // F key
                        $('#fullscreenBtn').click();
                        break;
                }
            });

            // Initialize
            preloadImages();
            startSlideshow();
        });
    </script>
}

