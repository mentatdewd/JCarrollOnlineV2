@using JCarrollOnlineV2.ViewModels.Sandbox
@model YellowstoneViewModel

@{
    Model.PageTitle = "Yellowstone Slide Show";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .carousel-control-panel {
        text-align: center;
        margin: 15px 0;
    }
    .carousel-control-panel .btn {
        margin: 0 5px;
    }
    .carousel-progress {
        height: 4px;
        background-color: #f0f0f0;
        position: relative;
        margin-bottom: 10px;
    }
    .carousel-progress-bar {
        height: 100%;
        background-color: #007bff;
        width: 0%;
        transition: width 0.3s ease;
    }
    #carouselExampleIndicators {
        background-color: #000;
        padding: 20px 0;
        min-height: 500px; /* Prevent collapse */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .carousel-inner {
        width: 100%;
        min-height: 500px;
    }
    .carousel-item {
        min-height: 500px;
        display: flex !important;
        align-items: center;
        justify-content: center;
        background-color: #000;
    }
    .carousel-item img {
        max-height: 70vh;
        max-width: 100%;
        width: auto;
        height: auto;
        margin: 0 auto;
        object-fit: contain;
        display: block;
    }
    .carousel-caption {
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
    }
    .image-counter {
        position: absolute;
        top: 10px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        z-index: 10;
    }
    /* Loading spinner */
    .carousel-item.loading::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 50px;
        height: 50px;
        margin: -25px 0 0 -25px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<div class="container-fluid">
    <h2>Yellowstone Slide Show</h2>
    
    <div class="carousel-progress">
        <div class="carousel-progress-bar" id="progressBar"></div>
    </div>

    <div class="carousel-control-panel">
        <button type="button" class="btn btn-primary" id="playPauseBtn">
            <span class="glyphicon glyphicon-pause"></span> Pause
        </button>
        <button type="button" class="btn btn-secondary" id="fullscreenBtn">
            <span class="glyphicon glyphicon-fullscreen"></span> Fullscreen
        </button>
        <span class="badge badge-info ml-2">
            <span id="currentSlide">1</span> / <span id="totalSlides">@Model.ImageFiles.Count()</span>
        </span>
    </div>

    <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel" data-interval="3000">
        <div class="image-counter">
            <span id="imageCounter">1 / @Model.ImageFiles.Count()</span>
        </div>
        
        <ol class="carousel-indicators">
            @for (int i = 0; i < Model.ImageFiles.Count(); i++)
            {
                <li data-target="#carouselExampleIndicators" data-slide-to="@i" class="@(i == 0 ? "active" : "")" title="Image @(i + 1)"></li>
            }
        </ol>
        
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="@Model.ImageFiles.FirstOrDefault().Path" alt="@Model.ImageFiles.FirstOrDefault().AltString" class="d-block" loading="eager" />
                <div class="carousel-caption d-none d-md-block">
                    <h3>Arrival in Yellowstone City</h3>
                    <p>The day of our arrival Ally went shopping</p>
                </div>
            </div>
            @foreach (var image in Model.ImageFiles.Skip(1))
            {
                <div class="carousel-item">
                    <img src="@image.Path" alt="@image.AltString" class="d-block" loading="lazy" />
                </div>
            }
        </div>
        
        <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>

    <div class="text-center mt-3">
        <p class="text-muted">
            <small>
                <span class="glyphicon glyphicon-info-sign"></span>
                Use arrow keys (← →) to navigate | Press Space to play/pause | Press F for fullscreen
            </small>
        </p>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            var $carousel = $('#carouselExampleIndicators');
            var isPlaying = true;
            var interval = 4000;
            var progressInterval;
            var totalSlides = @Model.ImageFiles.Count();

            // Preload all images
            function preloadAllImages() {
                $('.carousel-item img').each(function() {
                    var $img = $(this);
                    var $item = $img.closest('.carousel-item');
                    
                    // Add loading class
                    $item.addClass('loading');
                    
                    // Create preload image
                    var img = new Image();
                    img.onload = function() {
                        $item.removeClass('loading');
                    };
                    img.onerror = function() {
                        $item.removeClass('loading');
                        console.error('Failed to load image: ' + $img.attr('src'));
                    };
                    img.src = $img.attr('src');
                });
            }

            // Initialize carousel - wait a moment for first image to load
            setTimeout(function() {
                $carousel.carousel({
                    interval: interval,
                    pause: false,
                    wrap: true,
                    keyboard: false  // We'll handle keyboard ourselves
                });
            }, 100);

            // Update progress bar and counters
            function updateProgress() {
                var activeIndex = $('.carousel-item.active').index() + 1;
                var progress = (activeIndex / totalSlides) * 100;
                $('#progressBar').css('width', progress + '%');
                $('#currentSlide').text(activeIndex);
                $('#imageCounter').text(activeIndex + ' / ' + totalSlides);
            }

            // Preload next image
            function preloadNextImage() {
                var $allItems = $('.carousel-item');
                var currentIndex = $('.carousel-item.active').index();
                var nextIndex = (currentIndex + 1) % $allItems.length;
                var $preloadImg = $allItems.eq(nextIndex).find('img');
                
                if ($preloadImg.length && !$preloadImg[0].complete) {
                    var $item = $allItems.eq(nextIndex);
                    $item.addClass('loading');
                    
                    var img = new Image();
                    img.onload = function() {
                        $item.removeClass('loading');
                    };
                    img.onerror = function() {
                        $item.removeClass('loading');
                    };
                    img.src = $preloadImg.attr('src');
                }
            }

            // Play/Pause functionality
            $('#playPauseBtn').click(function () {
                if (isPlaying) {
                    $carousel.carousel('pause');
                    $(this).html('<span class="glyphicon glyphicon-play"></span> Play');
                    isPlaying = false;
                } else {
                    $carousel.carousel('cycle');
                    $(this).html('<span class="glyphicon glyphicon-pause"></span> Pause');
                    isPlaying = true;
                }
            });

            // Fullscreen functionality
            $('#fullscreenBtn').click(function () {
                var elem = $carousel[0];
                if (!document.fullscreenElement) {
                    if (elem.requestFullscreen) {
                        elem.requestFullscreen();
                    } else if (elem.webkitRequestFullscreen) {
                        elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) {
                        elem.msRequestFullscreen();
                    }
                    $(this).html('<span class="glyphicon glyphicon-resize-small"></span> Exit Fullscreen');
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                    $(this).html('<span class="glyphicon glyphicon-fullscreen"></span> Fullscreen');
                }
            });

            // Handle fullscreen change
            document.addEventListener('fullscreenchange', function () {
                if (!document.fullscreenElement) {
                    $('#fullscreenBtn').html('<span class="glyphicon glyphicon-fullscreen"></span> Fullscreen');
                }
            });

            // Keyboard navigation
            $(document).keydown(function (e) {
                switch (e.keyCode) {
                    case 37: // Left arrow
                        $carousel.carousel('prev');
                        break;
                    case 39: // Right arrow
                        $carousel.carousel('next');
                        break;
                    case 32: // Space bar
                        e.preventDefault();
                        $('#playPauseBtn').click();
                        break;
                    case 70: // F key
                        $('#fullscreenBtn').click();
                        break;
                }
            });

            // Update on slide change - use 'slide.bs.carousel' to preload before transition starts
            $carousel.on('slide.bs.carousel', function (e) {
                var nextIndex = $(e.relatedTarget).index();
                var $nextItem = $('.carousel-item').eq(nextIndex);
                var $nextImg = $nextItem.find('img');
                
                // Make sure next image is loaded before transitioning
                if (!$nextImg[0].complete) {
                    $nextItem.addClass('loading');
                }
            });
            
            $carousel.on('slid.bs.carousel', function () {
                updateProgress();
                preloadNextImage();
            });

            // Initialize
            updateProgress();
            preloadAllImages(); // Preload all images in background
            preloadNextImage(); // Ensure first few are loaded

            // Pause on hover
            $carousel.hover(
                function () {
                    if (isPlaying) {
                        $carousel.carousel('pause');
                    }
                },
                function () {
                    if (isPlaying) {
                        $carousel.carousel('cycle');
                    }
                }
            );
        });
    </script>
}

